---
title: fixed CORS problem caused by shiro
date: 2024-09-06 13:10:27
tags: [shiro,java,cors]
---

## problem

A developer from a business partner's company reported a CORS issue with our API.
The following error appeared in the browser console when they attempted to send a request:

```
Access to XMLHttpRequest at 'https://api.request' from origin 'https://client.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: It does not have HTTP ok status.
```

After investigating our web application, we confirmed that the necessary CORS headers like `Access-Control-Allow-Origin`, `Access-Control-Allow-Credentials`, `Access-Control-Allow-Methods`, `Access-Control-Allow-Headers`, `Access-Control-Max-Age`, `Access-Control-Expose-Headers` were all correctly included in the response.
Additionally, the actual API request from the client was responded to with a 200 status.

It appeared there were no issues with our CORS filter or API implementation.


## analysis

Using browser developer tools, we observed that an `OPTIONS` request was sent to our web application before the API call, and this `OPTIONS` request consistently failed with a 401 error.

The root cause is that our API is secured with Basic Auth. Each time the client attempted to call the API with a username and password, an `OPTIONS` preflight request was sent. This request is automatically generated by the browser (in this case, Chrome), but it lacks the Basic Auth header.

Since the `OPTIONS` request does not include authentication, it is blocked by our web application because URL-level access control is enforced, regardless of the HTTP method. The application expects a Basic Auth header for all requests, including `OPTIONS`.

## solution

The solution is straightforward: we need to customize the Shiro `BasicHttpAuthenticationFilter` to bypass authentication checks for `OPTIONS` requests while continuing to secure all other requests.

Here's how to implement this:

```java
public class ShiroAuthFilter extends BasicHttpAuthenticationFilter {

    @Override
    public boolean onPreHandle(final ServletRequest request, final ServletResponse response, final Object mappedValue) throws Exception {
        if (Objects.nonNull(request) && ((HttpServletRequest) request).getMethod().equals("OPTIONS")) {
            return true;
        }
        return super.onPreHandle(request, response, mappedValue);
    }
}

```

Next, use this customized filter in your `shiro.ini` configuration:

```ini
authc = com.echobase.filter.ShiroAuthFilter

```